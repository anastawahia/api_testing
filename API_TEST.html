<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG API Test</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        /* GPU Monitor Styles */
        .gpu-monitor {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .gpu-monitor h2 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gpu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .gpu-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .gpu-stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .gpu-stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .gpu-stat-sub {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .gpu-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .gpu-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #FFC107 70%, #F44336 100%);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .gpu-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .gpu-status.online {
            background: #4CAF50;
        }

        .gpu-status.offline {
            background: #F44336;
        }

        .gpu-refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .gpu-refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .gpu-error {
            background: rgba(244, 67, 54, 0.2);
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        .token-mode {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .token-mode label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
        }
        
        .token-mode input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }
        
        .token-input-group {
            display: none;
        }
        
        .token-input-group.active {
            display: block;
        }

        /* Admin Department Selection Styles */
        .admin-dept-selection {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #667eea;
        }

        .admin-dept-selection.active {
            display: block;
        }

        .dept-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .dept-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dept-checkbox-item:hover {
            background: #e8eaf6;
        }

        .dept-checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }

        .dept-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .admin-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .selected-depts-display {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 14px;
        }

        .selected-dept-tag {
            display: inline-block;
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            margin: 4px;
            font-size: 12px;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .result.show {
            display: block;
        }
        
        .result h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .answer {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            line-height: 1.8;
        }
        
        .sources {
            background: white;
            padding: 15px;
            border-radius: 6px;
        }
        
        .source-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c33;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1976d2;
        }

        .dept-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç RAG System API Test</h1>

        <!-- GPU Monitor Section -->
        <div class="gpu-monitor" id="gpuMonitor">
            <h2>
                üéÆ GPU Monitor 
                <span id="gpuStatus" class="gpu-status online">Online</span>
            </h2>
            <div id="gpuContent">
                <div class="gpu-grid">
                    <div class="gpu-stat">
                        <div class="gpu-stat-label">VRAM Usage</div>
                        <div class="gpu-stat-value" id="vramUsed">--</div>
                        <div class="gpu-stat-sub"*6 id="vramTotal"*6>-- / -- GB</div>
                        <div class="gpu-progress-bar">
                            <div class="gpu-progress-fill" id="vramProgress" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="gpu-stat">
                        <div class="gpu-stat-label">GPU Utilization</div>
                        <div class="gpu-stat-value" id="gpuUtil">--%</div>
                        <div class="gpu-progress-bar">
                            <div class="gpu-progress-fill" id="gpuUtilProgress" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="gpu-stat">
                        <div class="gpu-stat-label">Memory Utilization</div>
                        <div class="gpu-stat-value" id="memUtil">--%</div>
                        <div class="gpu-progress-bar">
                            <div class="gpu-progress-fill" id="memUtilProgress" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="gpu-stat">
                        <div class="gpu-stat-label">Temperature</div>
                        <div class="gpu-stat-value" id="gpuTemp">--¬∞C</div>
                    </div>
                </div>
                <button class="gpu-refresh-btn" onclick="fetchGPUStats()">üîÑ Refresh</button>
            </div>
            <div id="gpuError" class="gpu-error" style="display: none;"></div>
        </div>
        
        <div class="info">
            ‚ú® Enter your question and select a department or enter a custom key to get an answer from the system
        </div>
        
        <form id="queryForm">
            <div class="form-group">
                <label for="question">üìù Question:</label>
                <textarea 
                    id="question" 
                    placeholder="Example: What is the periodic maintenance policy?"
                    required
                >What is the periodic maintenance policy?</textarea>
            </div>
            
            <div class="form-group">
                <label>üîë Token Input Method:</label>
                <div class="token-mode">
                    <label>
                        <input type="radio" name="tokenMode" value="select" checked>
                        Select from department list
                    </label>
                    <label>
                        <input type="radio" name="tokenMode" value="custom">
                        Enter custom key
                    </label>
                </div>
            </div>

            <div class="form-group">
                <div id="selectMode" class="token-input-group active">
                    <label for="departmentSelect">üìÇ Select Department/Token:</label>
                    <select id="departmentSelect">
                        <option value="">-- Select Department --</option>
                        <option value="API_KEY_IT">IT (Information Technology)</option>
                        <option value="API_KEY_EMD">EMD (Electrical & Mechanical)</option>
                        <option value="API_KEY_MPO">MPO (Main Plant Operation)</option>
                        <option value="API_KEY_P">Performance</option>
                        <option value="API_KEY_MH">MH (Material Handling)</option>
                        <option value="ADMIN_KEY_MULTI">Admin (Multi-Department Access)</option>
                    </select>
                </div>

                <div id="customMode" class="token-input-group">
                    <label for="customToken">üîê Enter Custom Key:</label>
                    <input 
                        type="text" 
                        id="customToken" 
                        placeholder="API_KEY_XXXXX FOR YOUR DEPARTMENT"
                    >
                </div>
            </div>

            <!-- Admin Department Selection -->
            <div id="adminDeptSelection" class="admin-dept-selection">
                <div class="admin-notice">
                    üëë Admin Mode: Select one or more departments to query
                </div>
                <label>Select Departments to Query:</label>
                <div class="dept-checkboxes">
                    <div class="dept-checkbox-item">
                        <input type="checkbox" id="dept_IT" value="IT">
                        <label for="dept_IT">IT</label>
                    </div>
                    <div class="dept-checkbox-item">
                        <input type="checkbox" id="dept_EMD" value="EMD">
                        <label for="dept_EMD">EMD</label>
                    </div>
                    <div class="dept-checkbox-item">
                        <input type="checkbox" id="dept_MPO" value="main plant operation">
                        <label for="dept_MPO">Main Plant Operation</label>
                    </div>
                    <div class="dept-checkbox-item">
                        <input type="checkbox" id="dept_P" value="performance">
                        <label for="dept_P">Performance</label>
                    </div>
                    <div class="dept-checkbox-item">
                        <input type="checkbox" id="dept_MH" value="material handling">
                        <label for="dept_MH">Material Handling</label>
                    </div>
                </div>
                <div class="selected-depts-display" id="selectedDeptsDisplay">
                    <strong>Selected:</strong> <span id="selectedDeptsList">None</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="topK">üìä Number of Results (similarity_top_k):</label>
                <input 
                    type="number" 
                    id="topK" 
                    value="5"
                    min="1"
                    max="20"
                >
            </div>
            
            <button type="submit" id="submitBtn">
                Send Query
            </button>
        </form>
        
        <div id="loading" class="loading" style="display: none;">
            ‚è≥ Processing request...
        </div>
        
        <div id="result" class="result">
            <h3>üìå Answer:</h3>
            <div class="answer" id="answer"></div>
            
            <h3>üìö Sources:</h3>
            <div class="sources" id="sources"></div>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://azshjdxvzz63mt-8005.proxy.runpod.net';

        // GPU Monitoring Functions
        async function fetchGPUStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/gpu/stats`);
                if (!response.ok) throw new Error('Failed to fetch GPU stats');
                
                const data = await response.json();
                updateGPUDisplay(data);
                document.getElementById('gpuStatus').className = 'gpu-status online';
                document.getElementById('gpuStatus').textContent = 'Online';
                document.getElementById('gpuContent').style.display = 'block';
                document.getElementById('gpuError').style.display = 'none';
            } catch (error) {
                console.error('GPU stats error:', error);
                document.getElementById('gpuStatus').className = 'gpu-status offline';
                document.getElementById('gpuStatus').textContent = 'Offline';
                document.getElementById('gpuError').textContent = '‚ö†Ô∏è Unable to fetch GPU stats: ' + error.message;
                document.getElementById('gpuError').style.display = 'block';
                document.getElementById('gpuContent').style.display = 'none';
            }
        }

        function updateGPUDisplay(data) {
            // VRAM
            document.getElementById('vramUsed').textContent = `${data.memory.used_percent}%`;
            document.getElementById('vramTotal').textContent = `${data.memory.used_gb} / ${data.memory.total_gb} GB`;
            document.getElementById('vramProgress').style.width = `${data.memory.used_percent}%`;

            // GPU Utilization
            document.getElementById('gpuUtil').textContent = `${data.utilization.gpu_percent}%`;
            document.getElementById('gpuUtilProgress').style.width = `${data.utilization.gpu_percent}%`;

            // Memory Utilization
            document.getElementById('memUtil').textContent = `${data.utilization.memory_percent}%`;
            document.getElementById('memUtilProgress').style.width = `${data.utilization.memory_percent}%`;

            // Temperature
            document.getElementById('gpuTemp').textContent = `${data.temperature_celsius}¬∞C`;
        }

        // Auto-refresh GPU stats every 2 seconds
        let gpuRefreshInterval;
        function startGPUMonitoring() {
            fetchGPUStats(); // Initial fetch
            gpuRefreshInterval = setInterval(fetchGPUStats, 2000);
        }

        function stopGPUMonitoring() {
            if (gpuRefreshInterval) {
                clearInterval(gpuRefreshInterval);
            }
        }

        // Start monitoring on page load
        window.addEventListener('load', startGPUMonitoring);
        window.addEventListener('beforeunload', stopGPUMonitoring);

        // Department checkboxes
        const deptCheckboxes = document.querySelectorAll('.dept-checkbox-item input[type="checkbox"]');
        const selectedDeptsList = document.getElementById('selectedDeptsList');
        const adminDeptSelection = document.getElementById('adminDeptSelection');
        
        // Update selected departments display
        function updateSelectedDepts() {
            const selected = Array.from(deptCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.nextElementSibling.textContent);
            
            if (selected.length === 0) {
                selectedDeptsList.innerHTML = 'None';
            } else {
                selectedDeptsList.innerHTML = selected.map(dept => 
                    `<span class="selected-dept-tag">${dept}</span>`
                ).join('');
            }
        }

        deptCheckboxes.forEach(cb => {
            cb.addEventListener('change', updateSelectedDepts);
        });

        // Check if admin token
        function isAdminToken(token) {
            return token === 'ADMIN_KEY_MULTI' || token.startsWith('ADMIN_KEY') || token.startsWith('ADMIN');
        }

        // Control token input method display
        const tokenModeRadios = document.querySelectorAll('input[name="tokenMode"]');
        const selectMode = document.getElementById('selectMode');
        const customMode = document.getElementById('customMode');
        const departmentSelect = document.getElementById('departmentSelect');
        const customToken = document.getElementById('customToken');

        // Show/hide admin department selection
        function checkAndShowAdminSelection() {
            const selectedMode = document.querySelector('input[name="tokenMode"]:checked').value;
            let token = '';
            
            if (selectedMode === 'select') {
                token = departmentSelect.value;
            } else {
                token = customToken.value.trim();
            }

            if (isAdminToken(token)) {
                adminDeptSelection.classList.add('active');
            } else {
                adminDeptSelection.classList.remove('active');
            }
        }

        departmentSelect.addEventListener('change', checkAndShowAdminSelection);
        customToken.addEventListener('input', checkAndShowAdminSelection);

        tokenModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'select') {
                    selectMode.classList.add('active');
                    customMode.classList.remove('active');
                } else {
                    selectMode.classList.remove('active');
                    customMode.classList.add('active');
                }
                checkAndShowAdminSelection();
            });
        });

        // Handle form submission
        const form = document.getElementById('queryForm');
        const resultDiv = document.getElementById('result');
        const answerDiv = document.getElementById('answer');
        const sourcesDiv = document.getElementById('sources');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Hide previous results
            resultDiv.classList.remove('show');
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            const question = document.getElementById('question').value;
            const topK = parseInt(document.getElementById('topK').value);
            
            // Get token based on selected method
            let token;
            const selectedMode = document.querySelector('input[name="tokenMode"]:checked').value;
            
            if (selectedMode === 'select') {
                token = departmentSelect.value;
                if (!token) {
                    errorDiv.textContent = '‚ùå Please select a department from the list';
                    errorDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    submitBtn.disabled = false;
                    return;
                }
            } else {
                token = customToken.value.trim();
                if (!token) {
                    errorDiv.textContent = '‚ùå Please enter a custom key';
                    errorDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    submitBtn.disabled = false;
                    return;
                }
            }

            // Check if admin and get selected departments
            const isAdmin = isAdminToken(token);
            let departments = [];

            if (isAdmin) {
                departments = Array.from(deptCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (departments.length === 0) {
                    errorDiv.textContent = '‚ùå Admin must select at least one department';
                    errorDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    submitBtn.disabled = false;
                    return;
                }
            }
            
            try {
                // If admin with multiple departments, send multiple requests
                if (isAdmin && departments.length > 1) {
                    await handleMultipleDepartmentQuery(token, question, topK, departments);
                } else {
                    // Single department query
                    const requestBody = {
                        question: question,
                        similarity_top_k: topK
                    };

                    // Add department if admin
                    if (isAdmin && departments.length === 1) {
                        requestBody.department = departments[0];
                    }

                    const response = await fetch(`${API_BASE_URL}/v1/query`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.detail || 'An error occurred with the request');
                    }
                    
                    displaySingleResult(data, isAdmin && departments.length === 1 ? departments[0] : null);
                }
                
            } catch (error) {
                errorDiv.textContent = '‚ùå Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        async function handleMultipleDepartmentQuery(token, question, topK, departments) {
            const results = [];
            
            for (const dept of departments) {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/query`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            question: question,
                            department: dept,
                            similarity_top_k: topK
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        results.push({ department: dept, data: data, success: true });
                    } else {
                        results.push({ department: dept, error: data.detail, success: false });
                    }
                } catch (error) {
                    results.push({ department: dept, error: error.message, success: false });
                }
            }
            
            displayMultipleResults(results);
        }

        function displaySingleResult(data, departmentName = null) {
            // Display answer with department name if provided
            let answerHTML = data.answer || 'No answer available';
            if (departmentName) {
                answerHTML = `
                    <div style="margin-bottom: 10px;">
                        <span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                            ${departmentName}
                        </span>
                    </div>
                    ${answerHTML}
                `;
            }
            answerDiv.innerHTML = answerHTML;
            
            // Display sources
            if (data.sources && data.sources.length > 0) {
                sourcesDiv.innerHTML = data.sources.map((source, idx) => `
                    <div class="source-item">
                        <strong>Source ${idx + 1}:</strong><br>
                        üìÑ File: ${source.file_name || 'Not specified'}<br>
                        üìÑ Page: ${source.page_label || 'Not specified'}<br>
                        ${source.score ? `‚≠ê Score: ${source.score.toFixed(3)}` : ''}
                    </div>
                `).join('');
            } else {
                sourcesDiv.innerHTML = '<p>No sources available</p>';
            }
            
            resultDiv.classList.add('show');
        }

        function displayMultipleResults(results) {
            let answerHTML = '';
            let sourcesHTML = '';
            
            results.forEach(result => {
                if (result.success) {
                    answerHTML += `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 6px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">
                                üìÇ Department: ${result.department}
                            </h4>
                            <p>${result.data.answer || 'No answer available'}</p>
                        </div>
                    `;
                    
                    if (result.data.sources && result.data.sources.length > 0) {
                        sourcesHTML += `<h4 style="color: #667eea; margin-top: 15px; margin-bottom: 10px;">üìÇ ${result.department}</h4>`;
                        sourcesHTML += result.data.sources.map((source, idx) => `
                            <div class="source-item">
                                <strong>Source ${idx + 1}:</strong><br>
                                üìÑ File: ${source.file_name || 'Not specified'}<br>
                                üìÑ Page: ${source.page_label || 'Not specified'}<br>
                                ${source.score ? `‚≠ê Score: ${source.score.toFixed(3)}` : ''}
                            </div>
                        `).join('');
                    }
                } else {
                    answerHTML += `
                        <div style="margin-bottom: 20px; padding: 15px; background: #fee; border-radius: 6px;">
                            <h4 style="color: #c33; margin-bottom: 10px;">
                                üìÇ Department: ${result.department}
                            </h4>
                            <p>‚ùå Error: ${result.error}</p>
                        </div>
                    `;
                }
            });
            
            answerDiv.innerHTML = answerHTML;
            sourcesDiv.innerHTML = sourcesHTML || '<p>No sources available</p>';
            resultDiv.classList.add('show');
        }
    </script>
</body>
</html>

